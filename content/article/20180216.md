+++
date = "2018-02-16"
draft = false
lastmod = "2018-02-22T16:51:47+09:00"
title = "はじめてのMacPorts: FreeRDPを2.0.0-rc1にアップデートしてマージされた"
tags = ["Mac"]
+++

MacPortsに入っている[FreeRDP](https://github.com/FreeRDP/FreeRDP)が1.1系で古かったので、最新の2.0.0-rc1に更新してみました。FreeBSD portsのアップデートpatchを作るというのは日常的にやっているので、その

大体こんな流れ。

最初の2つは1回きりで手元にリポジトリを持っていれば省略できるので、適当に。

まずは[MacPortsのチケット検索ページ](https://trac.macports.org/wiki/Tickets)から、当該portのアップデートリクエスト等のチケットがないか確認します。あれば、後でコミットするときに「このチケットの作業やっといたよ」とコミットメッセージに書くためにURLを控えておきます。

次にPortfileをいじります。Portfileの書き方はFreeBSD portsのMakefileとは全然違うものの、FreeBSD portsに慣れていればなんとなく雰囲気でわかりました。ちょっと手こずったのが、FreeBSD portsの `make makesum` のような tarball のチェックサムを自動的に生成する手段がない(?)ところ。

もしかしたらあるのかもしれませんが、OpenSSLで2種類のチェックサムを生成して手でPortfileに書き込みました。

```shell
openssl dgst -rmd160 FreeRDP-2.0.0-rc1.tar.gz
openssl dgst -sha256 FreeRDP-2.0.0-rc1.tar.gz
```

コミットメッセージは[ガイドライン](https://trac.macports.org/wiki/CommitMessages)に沿うように。
そんなこんなで出来上がったのがこちらのコミット。とりあえず見様見真似。

- https://github.com/metalefty/macports-ports/commit/3c568d959d0725d8e8bfebd3a891ef1f48ea797a

そしてPull Requestを作成。
- [FreeRDP: Update to 2.0.0-rc1](https://github.com/macports/macports-ports/pull/1317)

Pull Requestにテンプレートがあって、以下のコマンドでテストしたMacの環境を添えます。

```shell
 echo "macOS $(sw_vers -productVersion) $(sw_vers -buildVersion)"; echo "Xcode $(xcodebuild -version | awk '{print $NF}' | tr '\n' ' ')"
```

他にも、
- コミットメッセージガイドラインに沿ったか
- 同じようなPull Requestがないことを確認したか
- Tracチケットがある場合URLでリンクをしたか(チケット番号だけではダメ)
- `port lint` コマンドで文法チェックをしたか
- `sudo port test` コマンドでテストを実行したか(テストがある場合)
- `sudo port -vst install` でインストールのテストをしたか
- 全てのバイナリの実行テストをしたか

といった項目の確認をします。Tracチケットがなかった場合、わざわざ作る必要はないのですが[うっかり作ってしまいました](https://trac.macports.org/ticket/55829)。うっかり作ったとはいえ、チケットを作ってしまったのでチケットのURLをコミットメッセージに含めました。

とりあえずここまで。提出したPull Requestがマージされるのか、それとも修正を求められるのか、とりあえず見守ります。野良portsとしてのビルドはご自由に。

## その後

無事にマージされました。いくつか指摘があって、

- PulseAudioのvariantを削除した理由をコミットメッセージで説明する
- うっかりepochを削除してしまったので元に戻す

という変更が必要でしたが、大きな変更ではありませんでした。

FreeRDP 2.0系ではMacとの互換性も向上していて、以前はPulseAudioを経由しないと音が出せなかったのがMacのネイティブオーディオをサポートしたため必要なくなったというのがvariantを削除した理由です。

