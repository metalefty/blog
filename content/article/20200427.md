+++
date = "2020-04-27"
draft = false
lastmod = "2020-04-28T00:11:28+09:00"
title = "FreeBSD ports 作成: sysutils/mackerel-agent"
tags = ['FreeBSD']
+++


はてなの提供するサーバリソース監視サービス [Mackerel.io](https://mackerel.io) のエージェントである [mackerel-agent](https://github.com/mackerelio/mackerel-agent/) のFreeBSD portsを作成しました。

* https://www.freshports.org/sysutils/mackerel-agent/
* https://svnweb.freebsd.org/ports/head/sysutils/mackerel-agent/

もともと非公式ながらFreeBSDに対応しているので、素直に作成するだけ。rc scriptは少々手直ししました。

一応インストール方法や使い方を解説しておきます。quarterlyには入れていないので、`pkg install` できるようになるのは2020年7月以降になります。それまではportsからインストールしてください。


```shell
# portmaster -d sysutils/mackerel-agent
```

or

```shell
# make -C /usr/ports/sysutils/mackerel-agent install clean
```

インストールできたら、`/usr/local/etc/mackerel-agent/mackerel-agent.conf` を編集してAPIキーを追加します。

```shell
$ sudoedit /usr/local/etc/mackerel-agent/mackerel-agent.conf
```


以下の行にAPIキーを書いておきます。最低限の初期設定はこれだけ。
```toml
apikey = "WRITE_API_KEY_HERE"
```


サービスを有効にして、

```shell
# sysrc mackerel_agent_enable=YES
mackerel_agent_enable:  -> yes
```

サービスを起動する。

```shell
# service mackerel_agent start
```

ログはsyslogに出るようになっています。

```shell
# tail -f /var/log/messages
Apr 22 18:22:09 icepick mackerel-agent[76166]: 2020/04/22 18:22:09 main.go:174: INFO <main> Starting mackerel-agent version:0.67.1, rev:, apibase:https://api.mackerelio.com
Apr 22 18:22:20 icepick mackerel-agent[76166]: 2020/04/22 18:22:20 command.go:735: INFO <command> Start: apibase = https://api.mackerelio.com, hostName = example.vmeta.jp, hostID = HOSTIDHOSTID

```

しばらくすると、mackerel.io のコンソールにメトリクスが表示されているはずです。

![](https://img.vmeta.jp/y0kjwa.png)


## GitHub Sponsors

GitHub Sponsors プログラムに参加し、無事に承認されました。ご支援いただけるとうれしいです。

* https://github.com/sponsors/metalefty


