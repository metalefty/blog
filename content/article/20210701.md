+++
date = "2021-07-01"
draft = false
lastmod = "2021-07-01T14:11:47+09:00"
title = "FreeBSDでMACアドレスごとにネットワークインターフェイス名を固定する"
tags = ["FreeBSD"]
+++

## 背景

FreeBSDでUSB接続のネットワークインターフェイスを使用すると接続した順に `ue0`, `ue1`, `ue2`…というようなインターフェイス名が割り当てられますが、インターフェイスの挿抜や再起動によってインターフェイス名が変わってしまい不便なことがあります。

## 実現方法

[devd](https://www.freebsd.org/cgi/man.cgi?query=devd&apropos=0&sektion=0&manpath=FreeBSD+13.0-RELEASE+and+Ports&arch=default&format=html)を使用します。詳しくは説明しませんが、大雑把にいうと「デバイスが接続されたり切断されたときになんかするやつ」です。

devdで`ue0`や`ue1`というデバイスが接続されたのを検出して、MACアドレスに対応するインターフェイス名に変更することで決まったインターフェイス名を割り当てるというからくりです。

まず、MACアドレスとインターフェイス名のマッピングを書いたファイルを `/etc/netifmap` に作成します。ファイル名とパスは任意で構いません。MACアドレスとインターフェイス名を空白文字区切りで書いておきます。

インターフェイス名は `foo[0-9]+` というフォーマットである必要はありません。`alice`や`bob`でもOKですが、元のインターフェイス名と同じ`ue[0-9]+`と重複するものは避けておきます。例えば`ue0`を`ue1`に変更し、`ue1`を`ue0`に変更するというようなスワップはうまくいきません。

ここでは、`eth[0-9]+`にしてみました。
```
00:11:22:33:44:55 eth0
00:11:22:33:44:66 eth1
```

次に、`/etc/rename-netif.sh` というスクリプトを作成します。スクリプトは末尾にGistで貼っておきます。
第一引数にインターフェイス名を与えると、マッピングファイルを参照しマッチしたインターフェイス名に変更するというスクリプトです。

最後に、このスクリプトがインターフェイス接続時に実行されるようにdevdの設定ファイルを書いておきます。 `/etc/devd/netif.conf`という名前で作成しますが、これも任意の名前で構いません。`ue[0-9]+`という名前にマッチするネットワークインターフェイスが接続されたら、`action`に指定したスクリプトが実行されます。

書き終わったら、`service devd restart`でdevdを再起動しておきます。再起動したら、USBネットワークインターフェイスを順番を変えて挿抜してみると固定のインターフェイス名が割り当てられていることが確認できます。OSごと再起動しても同じMACアドレスに対して同じインターフェイス名が割り当てられます。

##  今回作成した各ファイル
<script src="https://gist.github.com/metalefty/80d793d4c58a0a81f7a8df97c5127ff5.js"></script>


